# Kubernetes Ingress 리소스 정의
# 외부 트래픽을 클러스터 내부 서비스로 라우팅하는 Ingress 설정입니다.
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skald-ingress
  namespace: skald
  labels:
    app: skald
    component: ingress
  annotations:
    # API 경로 재작성: /api/* 경로를 /로 재작성하여 백엔드 서비스로 전달
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    
    # HTTPS 리다이렉트: HTTP 요청을 HTTPS로 자동 리다이렉트
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: sparrow-local-cluster-issuer
    
    # TLS 인증서 자동 발급 (cert-manager 사용 시)
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # CORS 설정 (필요시 주석 해제)
    # nginx.ingress.kubernetes.io/enable-cors: "true"
    # nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    # nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    # nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization"
    
    # 프록시 바디 크기 설정 (대용량 파일 업로드 시 필요)
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    
    description: "Skald 애플리케이션 Ingress - 외부 접속을 위한 라우팅 규칙"
spec:
  # Ingress 클래스 지정 (NGINX Ingress Controller 사용)
  ingressClassName: nginx
  
  # TLS/SSL 설정 (HTTPS 통신을 위한 인증서)
  # 실제 도메인과 인증서 정보로 수정 필요
  tls:
  - hosts:
    - skald.example.com  # 실제 도메인으로 변경 필요
    secretName: skald-tls-secret  # TLS 인증서가 저장된 Secret 이름
  
  rules:
  # 메인 도메인 규칙
  - host: skald.sparrow.local  # 실제 도메인으로 변경 필요
    http:
      paths:
      # Frontend UI 서비스로 라우팅 (/ 경로)
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ui-service
            port:
              number: 80
      
      # API 서비스로 라우팅 (/api/* 경로)
      - path: /api(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 8000
      
      # RabbitMQ Management UI로 라우팅 (/rabbitmq/* 경로) - 선택적
      # 보안을 위해 기본적으로 비활성화하거나 인증 추가 권장
      - path: /rabbitmq(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: rabbitmq-service
            port:
              number: 15672

---
# 설치 및 설정 가이드 (한국어 주석)

# 온프레미스 환경에서 Ingress Controller 설치 방법:
# 1. NGINX Ingress Controller 설치 (권장):
#    helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
#    helm repo update
#    helm install ingress-nginx ingress-nginx/ingress-nginx \
#      --namespace ingress-nginx \
#      --create-namespace \
#      --values ingress-nginx-values.yaml
#
# 2. MetalLB 설치 (LoadBalancer 타입 지원을 위해):
#    kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.12/config/manifests/metallb-native.yaml
#    kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)"
#
# 3. Ingress 클래스 확인:
#    kubectl get ingressclass
#
# TLS/SSL 인증서 설정 방법:
# 1. 자체 서명 인증서 사용 (테스트용):
#    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#      -keyout tls.key -out tls.crt \
#      -subj "/CN=skald.example.com"
#    kubectl create secret tls skald-tls-secret \
#      --namespace skald \
#      --key=tls.key \
#      --cert=tls.crt
#
# 2. Let's Encrypt 인증서 사용 (프로덕션용):
#    cert-manager 설치 후 ClusterIssuer 설정 필요
#
# cert-manager 사용 방법 (선택적):
# 1. cert-manager 설치:
#    kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
# 2. ClusterIssuer 생성 (Let's Encrypt):
#    apiVersion: cert-manager.io/v1
#    kind: ClusterIssuer
#    metadata:
#      name: letsencrypt-prod
#    spec:
#      acme:
#        server: https://acme-v02.api.letsencrypt.org/directory
#        email: admin@example.com
#        privateKeySecretRef:
#          name: letsencrypt-prod
#        solvers:
#        - http01:
#            ingress:
#              class: nginx
#
# 도메인 설정 가이드:
# 1. DNS 레코드 설정: Ingress Controller의 외부 IP를 도메인에 연결
# 2. LoadBalancer IP 확인: kubectl get svc -n ingress-nginx
# 3. A 레코드 추가: skald.example.com -> <LoadBalancer-IP>
#
# Ingress 클래스 선택 옵션:
# - nginx: NGINX Ingress Controller (가장 일반적)
# - traefik: Traefik Ingress Controller
# - haproxy: HAProxy Ingress Controller
# - istio: Istio Gateway (서비스 메시 환경)