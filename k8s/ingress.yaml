# Kubernetes Ingress 리소스 정의
# 외부 트래픽을 클러스터 내부 서비스로 라우팅하는 Ingress 설정입니다.
# NGINX Ingress Controller를 사용하도록 표준 Ingress로 구성
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: skald-ingress
  namespace: skald
  labels:
    app: skald
    component: ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/use-regex: "true"
spec:
  tls:
  - hosts:
    - ${UI_DOMAIN}
    - ${API_DOMAIN}
    secretName: skald-tls-secret
  rules:
  - host: ${UI_DOMAIN}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ui-service
            port:
              number: 80
  - host: ${API_DOMAIN}
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 8080

---
# 설치 및 설정 가이드 (한국어 주석)

# 온프레미스 환경에서 Ingress Controller 설치 방법:
# 1. NGINX Ingress Controller 설치 (권장):
#    helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
#    helm repo update
#    helm install ingress-nginx ingress-nginx/ingress-nginx \
#      --namespace ingress-nginx \
#      --create-namespace \
#      --values ingress-nginx-values.yaml
#
# 2. MetalLB 설치 (LoadBalancer 타입 지원을 위해):
#    kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.12/config/manifests/metallb-native.yaml
#    kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)"
#
# 3. Ingress 클래스 확인:
#    kubectl get ingressclass
#
# TLS/SSL 인증서 설정 방법:
# 1. 자체 서명 인증서 사용 (테스트용):
#    openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#      -keyout tls.key -out tls.crt \
#      -subj "/CN=skald.example.com"
#    kubectl create secret tls skald-tls-secret \
#      --namespace skald \
#      --key=tls.key \
#      --cert=tls.crt
#
# 2. Let's Encrypt 인증서 사용 (프로덕션용):
#    cert-manager 설치 후 ClusterIssuer 설정 필요
#
# cert-manager 사용 방법 (선택적):
# 1. cert-manager 설치:
#    kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
# 2. ClusterIssuer 생성 (Let's Encrypt):
#    apiVersion: cert-manager.io/v1
#    kind: ClusterIssuer
#    metadata:
#      name: letsencrypt-prod
#    spec:
#      acme:
#        server: https://acme-v02.api.letsencrypt.org/directory
#        email: admin@example.com
#        privateKeySecretRef:
#          name: letsencrypt-prod
#        solvers:
#        - http01:
#            ingress:
#              class: nginx
#
# 도메인 설정 가이드:
# 1. DNS 레코드 설정: Ingress Controller의 외부 IP를 도메인에 연결
# 2. LoadBalancer IP 확인: kubectl get svc -n ingress-nginx
# 3. A 레코드 추가: skald.example.com -> <LoadBalancer-IP>
#
# Ingress 클래스 선택 옵션:
# - nginx: NGINX Ingress Controller (가장 일반적)
# - traefik: Traefik Ingress Controller
# - haproxy: HAProxy Ingress Controller
# - istio: Istio Gateway (서비스 메시 환경)